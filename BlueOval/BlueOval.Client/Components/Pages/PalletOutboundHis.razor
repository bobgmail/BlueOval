@page "/OutboundReportHis"

@using ClosedXML.Excel;

@inject DapperContextApi sqlService;
@inject IJSRuntime JS

<PageTitle>Pallets Outbound Query</PageTitle>
<MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
    <MudGrid Class="pa-4 gap-2 align-center">
        <MudItem >
            <MudText Typo="Typo.h5" Class="ml-3" Color="Color.Success">Pallets Outbound Query</MudText>
        </MudItem>
        <MudItem>
            <MudSelect Dense="true" T="int" Label="Select Shift Time" Variant="Variant.Outlined" @bind-Value="LocationId" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="int" Value="0">@GetNightStr(false)</MudSelectItem>
                <MudSelectItem T="int" Value="1">@GetNightStr(true)</MudSelectItem>
                <MudSelectItem T="int" Value="2">0:00 AM~24:00 PM</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem >
            <MudDateRangePicker Label="Please Select Date" DateFormat="dd/MM/yyyy" Variant="Variant.Outlined" Style="width:300px;" TitleDateFormat="dddd, dd. MMMM" @bind-DateRange="RangeDateValue" />
        </MudItem>

        <MudItem >
            <MudText Typo="Typo.h6" Class="ml-3" Color="Color.Warning">@GetPalletInfo()</MudText>
        </MudItem>
        <MudItem>
            <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Class="py-2"
                       OnClick="DownloadFileFromStream"
                       Color="Color.Primary">Generate Excel Report</MudButton>

        </MudItem>
        @if (isUpdating != 0)
        {
            <MudItem>
             <MudProgressCircular Color="Color.Success" Style="height:50px;width:50px;" Indeterminate="true" />
            </MudItem>
        }
    </MudGrid>
</MudForm>

<MudGrid Spacing="1">
    <MudItem xs="8">
   
        <MudTable Class="mx-2" Items="@Pallets" @ref="mudTable" T="PalletInfo"
                      Height="700px" FixedHeader="true" Style="height:700px;"
                  Outlined="true" Elevation="1" 
                  Dense="true" Hover="true" Bordered="true" Striped="true">
   
            <HeaderContent>
                <MudTh>Shipped Date</MudTh>
                <MudTh>Part #</MudTh>
                <MudTh>Skid #</MudTh>
                <MudTh>Part Qty</MudTh>
                <MudTh>Notes</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd >@context.CreatedDate.ToString("MMMdd@hh:mmtt")</MudTd>
                <MudTd>@context.PartNo</MudTd>
                <MudTd>@context.SkidNo</MudTd>
                <MudTd>@context.Qty</MudTd>
                <MudTd>@context.Notes</MudTd>
            </RowTemplate>

        </MudTable>
       
    </MudItem>
    <MudItem xs="4" >
       
            <MudTable Class="mx-2" Items="@PartSum"  T="InfoSummary"
                      Height="700px" FixedHeader="true"
                      Outlined="true" Elevation="1"
                      Dense="true" Hover="true" Bordered="true" Striped="true" >
             



                <HeaderContent>
                    <MudTh>Part #</MudTh>
                    <MudTh>Total Qty</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>@context.Qty</MudTd>
                </RowTemplate>

            </MudTable>
       
    </MudItem>

</MudGrid>




@code{
    int isUpdating = 0;
    private bool success;
    private MudForm form;
    private string[] errors = { };
    DateRange _dateRange = new DateRange(DateTime.Now.Date, DateTime.Now.Date);
    private DateRange RangeDateValue
    {
        get => _dateRange;
        set
        {
            _dateRange = value;

            //GetItems();
        }
    }

    private string GetNightStr(bool bNight)
    {
        int day = SiteControl.GetShiftStart(0);
        int night =  SiteControl.GetShiftStart(1);

        if (bNight)
            return night + ":00 PM~" + day + ":00 AM";
        return day + ":00 AM~" + night + ":00 PM";
    }

    int _LocationId = 2;
    public  int LocationId {
        get
        {
            return _LocationId;
        }
        set
        {
            int n = _LocationId;
            _LocationId = value;
            if(n != value)
            {
                OnRangeSelect(null);
                // await FetchRangeInfos();
                //StateHasChanged();
            }

            // FetchPartsAtLocation();
            // SetFocus();
        }
    }//= -1;

    DateTimeOffset? StartDate { get; set; } = DateTime.Today;
    DateTimeOffset? EndDate { get; set; } = DateTime.Today;

    public async void OnRangeSelect(DateRange range)
    {
        //Use range.Start and range.End here
        await FetchRangeInfos();
        StateHasChanged();
    }

    private async Task FetchRangeInfos()
    {
        if (StartDate.HasValue == false || EndDate.HasValue == false)
            return;
        DateTime s = StartDate.Value.Date;
        DateTime e = EndDate.Value.Date.AddHours(24);
        //switch(LocationId)
        //{
        //    case 0:
        //        s = s.AddHours(6);
        //        e = e.AddHours(6 + 12);
        //        break;
        //    case 1:
        //        s = s.AddHours(6+12);
        //        e = e.AddHours(6);
        //        break;
        //    case 2:
        //        s = s.AddHours(0);
        //        e = e.AddHours(24);
        //        break;

        //}
        Pallets =  await sqlService.GetOutboundWithTimeRange(s,e,LocationId);
        PartSum =  await sqlService.GetOutboundPartsSummary(s,e,LocationId);

    }

    private List<PalletInfo> Pallets = new List<PalletInfo>();
    private List<InfoSummary> PartSum = new List<InfoSummary>();

    protected string GetPalletInfo()
    {
        string ret = "Total " + Pallets.Count + " Pallets";
        return ret;
    }

    protected override async Task OnInitializedAsync()
    {
        await FetchRangeInfos();
    }
    private MudTable<PalletInfo> mudTable;
    private PalletInfo selectedItem1 = null;
    private int selectedRowNumber = -1;
    private string SelectedRowClassFunc(PalletInfo element, int rowNumber)
    {
        //if (selectedRowNumber == rowNumber)     //Selected Row: None
        //{
        //    selectedRowNumber = -1;

        //    return string.Empty;
        //}
        //else
        if (mudTable.SelectedItem != null && mudTable.SelectedItem.Equals(element))    //Selected Row: {rowNumber}
        {
            selectedRowNumber = rowNumber;

            return "selected";
        }
        else
        {
            return string.Empty;
        }
    }
    private string searchString1 = "";
    private bool FilterFunc1(PalletInfo element) => FilterFunc(element, searchString1);
    private bool FilterFunc(PalletInfo element, string searchString)
    {
        return true;
    }
    private async Task<Stream> GetExcelFile()
    {
        string name = "Outbound " + GetPalletInfo();
        IXLWorkbook wb = new XLWorkbook();
        IXLWorksheet ws = wb.Worksheets.Add(name);

        int row = 1;
        int col = 1;
        ws.Cell(row, col++).Value = "Received Date";
        ws.Cell(row, col++).Value = "Part #";
        ws.Cell(row, col++).Value = "Skid #";
        ws.Cell(row, col++).Value = "Part Qty";
        ws.Cell(row, col++).Value = "Notes";

        row++;
        col = 1;
        foreach (var scan in Pallets)
        {
            ws.Cell(row, col++).Value = scan.CreatedDate.ToString("MMMdd@hh:mmtt");
            ws.Cell(row, col++).Value = scan.PartNo;
            ws.Cell(row, col++).Value = scan.SkidNo;
            ws.Cell(row, col++).Value = scan.Qty;
            ws.Cell(row, col++).Value = scan.Notes;

            row++;
            col = 1;
        }

        IXLWorksheet ws1 = wb.Worksheets.Add("Summary");
        row = 1;
        col = 1;
        ws1.Cell(row, col++).Value = "Part #";
        ws1.Cell(row, col++).Value = "Total Qty";

        row++;
        col = 1;
        foreach (var scan in PartSum)
        {
            ws1.Cell(row, col++).Value = scan.Name;
            ws1.Cell(row, col++).Value = scan.Qty;

            row++;
            col = 1;
        }

        //Then adjust the columns
        ws.Columns().AdjustToContents();
        var stream = new MemoryStream();

        wb.SaveAs(stream);
        stream.Position = 0;
        return stream;
    }


    private async Task DownloadFileFromStream()
    {
        if (LocationId == -1 || Pallets == null || Pallets.Count == 0)
            return;
        isUpdating = 1;
        StateHasChanged();
        await Task.Delay(100);
        var fileStream = await GetExcelFile();


        using var streamRef = new DotNetStreamReference(stream: fileStream);

        string FileName = "Outbound "; 
        switch(LocationId)
        {
            case 0:
                FileName += "6:00AM~6:00PM";
                break;
            case 1:
                FileName += "6:00PM~6:00AM";
                break;
            case 2:
                FileName += "0:00AM~24:00PM";
                break;
        }
        FileName += " " + StartDate?.Date.ToString("yyyy-MM-dd") + "~" + EndDate?.Date.ToString("yyyy-MM-dd") + ".xlsx";
        await JS.InvokeVoidAsync("downloadFileFromStream", FileName, streamRef);
        isUpdating = 0;
        StateHasChanged();
        await Task.Delay(100);
        //Stream fileStream = await sqlService.GetShipmentReportFile(null);
        //if (fileStream == null)
        //    return;

        //using var streamRef = new DotNetStreamReference(stream: fileStream);

        //string FileName = "Inbound Report ";
        //if(StartDate.Value.Date == EndDate.Value.Date)
        //{
        //    FileName += StartDate.Value.DateTime.ToString("yyyy-MM-dd") + ".xlsx";
        //}
        //else
        //{
        //    FileName += StartDate.Value.DateTime.ToString("yyyy-MM-dd");
        //    FileName += "_";
        //    FileName += EndDate.Value.DateTime.ToString("yyyy-MM-dd") + ".xlsx";
            
        //}

        //await JS.InvokeVoidAsync("downloadFileFromStream", FileName, streamRef);
    }

    private async void GenerateTheReport()
    {

        //if (CtrlList.Count == 0 )
        //    return;


        await DownloadFileFromStream();


        StateHasChanged();

    }

   
}